#!/bin/make
# optional LIBCMP_INC defines where the libcmp header files will be placed (default: "./include_cmp")
# optional LIBCMP_OUT defines where the resulting cmp lib will be placed (default: ".")
# both may contain absolute path or path relative to the dir containing this Makefile
# optional OPENSSL_DIR defines absolute or relative path to OpenSSL installation

ifeq ($(OS),Windows_NT)
#   EXE=.exe
    DLL=.dll
    OBJ=.obj
    LIB=bin
else
#   EXE=
    DLL=.so
    OBJ=.o
    LIB=lib
endif

ifeq ($(LIBCMP_OUT),)
     LIBCMP_OUT=.
endif

SYSTEM_INCLUDE_OPENSSL=/usr/include/openssl
ifeq ($(OPENSSL_DIR),)
   ifneq (,$(wildcard $(SYSTEM_INCLUDE_OPENSSL)))
     OPENSSL_DIR=/usr
   else
     OPENSSL_DIR=.
   endif
endif
ifeq ($(shell echo $(OPENSSL_DIR) | grep "^/"),)
# $(OPENSSL_DIR) is relative path
    OPENSSL=$(OPENSSL_DIR)
    OPENSSL_LIB=$(OPENSSL)
    OPENSSL_RPATH=$(OPENSSL)
    OPENSSL_RPATH_LIB=$(OPENSSL)
else
# $(OPENSSL_DIR) is absolute path
    OPENSSL=$(OPENSSL_DIR)
    OPENSSL_LIB=$(OPENSSL)/$(LIB)
    OPENSSL_RPATH=$(OPENSSL_DIR)
    OPENSSL_RPATH_LIB=$(OPENSSL_LIB)
endif

ifeq ($(findstring clean,$(MAKECMDGOALS)),)
OPENSSL_VERSION=$(shell $(MAKE) -s --no-print-directory -f OpenSSL_version.mk LIB=h OPENSSL_DIR="$(OPENSSL_DIR)")
ifeq ($(OPENSSL_VERSION),)
    $(warning cannot determine version of OpenSSL in directory '$(OPENSSL_DIR)', assuming 1.0.2)
    OPENSSL_VERSION=1.0
endif
$(info detected OpenSSL version $(OPENSSL_VERSION).x)
OSSL_VERSION_QUIRKS=-D'DEPRECATEDIN_1_2_0(f)= ' # needed for 1.2
ifeq ($(shell expr $(OPENSSL_VERSION) \< 1.1),1) # same as comparing == 1.0
    $(info enabling compilation quirks for OpenSSL 1.0.2)
    OSSL_VERSION_QUIRKS+=-Wno-discarded-qualifiers -Wno-unused-parameter# #-D'DEPRECATEDIN_1_1_0(f)=f;' -D'DEPRECATEDIN_1_0_0(f)='
endif
endif

LIBCMP_INC ?= $(LIBCMP_OUT)/include_cmp
LIBCMP=$(LIBCMP_OUT)/libcmp$(DLL)
#VERSION=.0

CC=gcc
ifdef NDEBUG
    override CFLAGS += -DNDEBUG=1 -O2
else
    override CFLAGS += -g# # not every compiler(version) supports -Og
endif
override CFLAGS += -fPIC -I$(LIBCMP_INC)
override CFLAGS += -DDEBUG_UNUSED -DPEDANTIC -pedantic -Wall -Wextra -Wswitch -Wsign-compare -Wmissing-prototypes -Wstrict-prototypes -Wshadow -Wformat -Wtype-limits -Wundef $(OSSL_VERSION_QUIRKS)# -Werror # not needed for cmp+crmf: -Wno-long-long -Wno-missing-field-initializers
override CFLAGS += -isystem $(OPENSSL_DIR)/include # use of -isystem is critical for selecting wanted OpenSSL version
LIBCMP_HDRS_INC = -include $(LIBCMP_INC)/openssl/crmf.h # used to force inclusion of standalone version, needed also for cmp_err.c

LDFLAGS += -L$(OPENSSL_LIB) -L$(OPENSSL) -Wl,-rpath=$(OPENSSL_RPATH_LIB) -Wl,-rpath=$(OPENSSL_RPATH)
LDLIBS  += -lcrypto

LIBCMP_HDRS_= crmf.h cmp.h cmperr.h crmferr.h safestack_backport.h
LIBCMP_HDRS = $(patsubst %,include/openssl/%,$(LIBCMP_HDRS_))
LIBCMP_INC_HDRS = $(patsubst %,$(LIBCMP_INC)/openssl/%,$(LIBCMP_HDRS_))
CMP_SRCS_ = cmp_asn.c cmp_ctx.c cmp_err.c cmp_http.c cmp_lib.c cmp_msg.c cmp_ses.c cmp_srv.c cmp_vfy.c
CRMF_SRCS_ = crmf_asn.c crmf_err.c crmf_lib.c crmf_pbm.c
LIBCMP_SRCS = $(patsubst %,crypto/crmf/%,$(CRMF_SRCS_)) $(patsubst %,crypto/cmp/%,$(CMP_SRCS_))

.phony: build clean

build: $(LIBCMP)

$(LIBCMP_INC)/openssl:
	@mkdir -p $(LIBCMP_OUT)
	@mkdir -p $(LIBCMP_INC)/openssl

$(LIBCMP_INC_HDRS): $(LIBCMP_HDRS) | $(LIBCMP_INC)/openssl
	cp $(LIBCMP_HDRS) $(LIBCMP_INC)/openssl # --preserve=timestamps has no effect on WSL
	@cd $(LIBCMP_INC)/openssl && ((mv crmf.h tmp2.h && /bin/echo -e "#undef CMP_STANDALONE\n#define CMP_STANDALONE\n" >tmp1.h && cat tmp1.h tmp2.h >crmf.h && touch -r tmp2.h crmf.h); rm -f tmp1.h tmp2.h)

$(LIBCMP): $(LIBCMP_INC_HDRS) $(LIBCMP_HDRS) $(LIBCMP_SRCS)
	$(CC) $(CFLAGS) $(LIBCMP_HDRS_INC) $(LIBCMP_SRCS) $(LDFLAGS) $(LDLIBS) -shared -o $@
	@# # -Wl,-soname,libcmp$(DLL)$(VERSION)
	@# #ln -sr $(LIBCMP) $(LIBCMP)$(VERSION)

clean:
	rm -f $(LIBCMP_INC)/openssl/* $(LIBCMP)
	rm -f $(LIBCMP) # $(LIBCMP)$(VERSION)
	rmdir $(LIBCMP_INC)/openssl $(LIBCMP_INC) 2>/dev/null || true

SYSTEM_LIB=/usr/lib
DEST_LIB=$(DESTDIR)$(prefix)$(SYSTEM_LIB)
DEST_INC=$(DESTDIR)$(prefix)$(SYSTEM_INCLUDE_OPENSSL)
LIBCMP_HDRS_install = $(patsubst %,$(DEST_INC)/%,$(LIBCMP_HDRS_))

.phony: install uninstall install_clean

install: $(LIBCMP)
	mkdir -p $(DEST_LIB)
	install -D $(LIBCMP) $(DEST_LIB)
	mkdir -p $(DEST_INC)
	install -D $(LIBCMP_INC)/openssl/*.h $(DEST_INC)

install_clean:
	rm -f $(DEST_LIB)/libcmp$(DLL) $(LIBCMP_HDRS_install)

uninstall: install_clean

#SRCS=$(shell ls Makefile_cmp include/openssl/{{cmp,crmf}{,err}.h,safestack_backport.h} crypto/{cmp,crmf}/*.{c,h})
#SRCS_TAR=cmpossl_0.1.0.orig.tar.gz
.phony: deb deb_clean
deb:
	@# #tar czf $(SRCS_TAR) $(SRCS)
	@# #rm -f $(LIBCMP) debian/tmp/usr/lib/libcmp.so*
	debuild -uc -us -I* --lintian-opts --profile debian
	rm -r debian/tmp
	@ #rm $(SRCS_TAR)

deb_clean:
	rm ../libcmp*.deb
